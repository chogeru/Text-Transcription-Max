<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–‡å­—ãŠã“ã—Max</title>
    <style>
        :root {
            --bg-body: #F5F5F7; 
            --bg-card: #FFFFFF;
            --text-main: #1D1D1F; 
            --text-sub: #86868B;
            --accent: #0071E3; 
            --accent-grad: linear-gradient(135deg, #0071E3, #42A5F5);
            --record-red: #FF3B30;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 30px rgba(0,0,0,0.12);
            --max-width: 800px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", "Hiragino Kaku Gothic ProN", sans-serif;
            background: var(--bg-body); color: var(--text-main);
            margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Header --- */
        header {
            flex-shrink: 0; padding: 14px 20px; padding-top: max(14px, env(safe-area-inset-top));
            background: rgba(245, 245, 247, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.06); transition: all 0.3s ease;
        }
        .brand { 
            display: flex; align-items: center; gap: 8px; font-size: 19px; font-weight: 700; 
            color: #1D1D1F; letter-spacing: -0.5px; 
        }
        .brand span { 
            background: var(--accent-grad); -webkit-background-clip: text; color: transparent; 
            font-style: italic; font-weight: 800;
        }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { 
            background: transparent; border: none; font-size: 20px; cursor: pointer; 
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s, transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .icon-btn:hover { background: rgba(0,0,0,0.05); }
        .icon-btn:active { transform: scale(0.85); background: rgba(0,0,0,0.1); }

        /* --- Main Content --- */
        main { 
            flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch;
            padding: 20px; padding-bottom: 240px; display: flex; flex-direction: column; align-items: center;
        }
        #editor-container { width: 100%; max-width: var(--max-width); }
        
        /* Chat Bubble Animation */
        .msg-bubble {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 18px 22px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid transparent;
            animation: slideUpFade 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-origin: center bottom;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .msg-bubble:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        
        .msg-time {
            font-size: 11px; color: var(--text-sub); font-weight: 600; margin-bottom: 6px; display: block;
            opacity: 0.8;
        }
        .msg-text {
            font-size: 16px; line-height: 1.75; color: var(--text-main); white-space: pre-wrap; word-break: break-all;
        }

        .system-msg {
            text-align: center; font-size: 12px; color: var(--text-sub); margin: 24px 0;
            display: flex; align-items: center; justify-content: center; gap: 12px; opacity: 0.8;
        }
        .system-msg::before, .system-msg::after { content: ""; height: 1px; background: #E5E5EA; width: 40px; }

        @keyframes slideUpFade { 
            from { opacity: 0; transform: translateY(15px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        /* Empty State */
        #empty-state {
            text-align: center; margin-top: 120px; color: var(--text-sub);
            display: flex; flex-direction: column; align-items: center; gap: 16px;
            animation: fadeIn 0.8s ease;
        }
        #empty-state svg { width: 64px; height: 64px; fill: #D1D1D6; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Audio Player */
        #audioPlayerContainer {
            margin-top: 24px; padding: 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-radius: 20px; display: none; align-items: center; gap: 12px; 
            box-shadow: var(--shadow-lg); border: 1px solid rgba(0,0,0,0.05); 
            animation: slideUpFade 0.4s ease;
        }
        audio { height: 40px; width: 100%; outline: none; }

        /* --- Controls Bar --- */
        .controls-container {
            position: fixed; bottom: 0; left: 0; right: 0; padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            background: linear-gradient(to top, var(--bg-body) 20%, rgba(245,245,247,0.8) 60%, transparent);
            pointer-events: none; z-index: 500; display: flex; justify-content: center;
        }
        .controls-inner {
            pointer-events: auto; width: 100%; max-width: 520px;
            display: flex; flex-direction: column; align-items: center; gap: 18px;
        }
        
        .toolbar {
            background: rgba(255,255,255,0.85); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            padding: 8px 10px; border-radius: 24px; width: 100%; box-sizing: border-box;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.4);
            display: flex; gap: 8px; justify-content: space-between; align-items: center;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        select { 
            border:none; background:transparent; font-weight:600; font-size:14px; 
            color: #1D1D1F; cursor: pointer; outline: none; padding: 0 8px;
            font-family: inherit;
        }
        .btn-sm { 
            padding: 12px 18px; border-radius: 16px; font-size: 13px; font-weight:700; border:none; cursor:pointer; 
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; align-items: center; gap: 6px;
        }
        .btn-upload { background: rgba(0,0,0,0.04); color: #333; }
        .btn-upload:hover { background: rgba(0,0,0,0.08); }
        .btn-run { 
            background: var(--text-main); color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .btn-run:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn-run:active, .btn-upload:active { transform: scale(0.92); }

        /* Record Button with Pulse */
        .record-wrapper { position: relative; width: 76px; height: 76px; display: flex; justify-content: center; align-items: center;}
        .btn-record {
            width: 68px; height: 68px; border-radius: 50%; background: var(--record-red);
            border: 4px solid #fff; box-shadow: 0 8px 24px rgba(255, 59, 48, 0.35);
            cursor: pointer; display: flex; justify-content: center; align-items: center; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 2;
        }
        .btn-record:active { transform: scale(0.9); }
        .btn-record svg { fill: white; width: 30px; height: 30px; transition: 0.3s; }
        
        .record-ring {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid var(--record-red); opacity: 0; z-index: 1; pointer-events: none;
        }
        .recording .btn-record { transform: scale(0.85); border-radius: 36%; box-shadow: none; background: var(--record-red); }
        .recording .btn-record svg { opacity: 0; transform: scale(0.5); }
        .recording .record-ring { animation: ripple 1.5s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes ripple { 0% {transform: scale(0.85); opacity: 0.8;} 100% {transform: scale(1.6); opacity: 0;} }
        #stopIcon { width:22px; height:22px; background:white; border-radius:4px; position:absolute; opacity:0; transition:0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: scale(0.5); }
        .recording #stopIcon { opacity: 1; transform: scale(1); }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 2000; 
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal { 
            background: rgba(255,255,255,0.95); width: 90%; max-width: 600px; padding: 32px; border-radius: 28px; 
            max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.25);
            transform: translateY(30px) scale(0.95); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.open .modal { transform: translateY(0) scale(1); }
        .ai-result { 
            background: #F2F2F7; padding: 24px; border-radius: 20px; 
            white-space: pre-wrap; margin-top: 16px; font-size: 15px; line-height: 1.7; color: #333; 
            border: 1px solid rgba(0,0,0,0.03);
        }

        /* Loading Overlay (AI Processing) */
        #loadingOverlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.6); backdrop-filter: blur(8px);
            z-index: 3000; display: none; align-items: center; justify-content: center; flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        .pulse-logo {
            font-size: 50px; animation: pulse 1.5s infinite ease-in-out;
            margin-bottom: 15px;
        }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }
        .loading-text { font-weight: 700; color: #333; font-size: 14px; letter-spacing: 0.5px; }

        #fileInput { display: none; }
        
        .api-link-btn {
            display: block; text-align: center; margin-bottom: 15px;
            padding: 10px; background: #E3F2FD; color: #0071E3; 
            text-decoration: none; border-radius: 12px; font-weight: 700; font-size: 13px;
            border: 1px solid rgba(0,113,227,0.1); transition: 0.2s;
        }
        .api-link-btn:hover { background: #D1E9FC; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:#1D1D1F;"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        æ–‡å­—ãŠã“ã—<span>Max</span>
    </div>
    <div class="header-actions">
        <button class="icon-btn" onclick="clearLogs()" title="å…¨ã¦å‰Šé™¤">ğŸ—‘ï¸</button>
        <button class="icon-btn" onclick="shareText()" title="å…±æœ‰">ğŸ“¤</button>
        <button class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
    </div>
</header>

<main id="mainScroll">
    <div id="editor-container">
        <div id="empty-state">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            <p style="font-weight: 500;">éŒ²éŸ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¼šè©±ã‚’é–‹å§‹<br><span style="font-size:13px; opacity:0.6;">ã¾ãŸã¯éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿</span></p>
        </div>
        
        <div id="logArea"></div>

        <div id="audioPlayerContainer">
            <div style="display:flex; flex-direction:column; gap:2px;">
                <span style="font-size:11px; font-weight:800; color:#FF3B30; letter-spacing:0.5px;">REC DATA</span>
                <span style="font-size:10px; color:#888;">éŸ³å£°å†ç”Ÿ</span>
            </div>
            <audio id="audioPlayer" controls></audio>
            <a id="downloadLink" style="font-size:12px; color:#0071E3; font-weight:700; text-decoration:none; padding:8px 14px; background:rgba(0,113,227,0.1); border-radius:10px; transition:0.2s;">ä¿å­˜</a>
        </div>
    </div>
</main>

<div class="controls-container">
    <div class="controls-inner">
        <div class="toolbar">
            <select id="modeSelect">
                <option value="summary">âœ¨ è¦ç´„ã™ã‚‹</option>
                <option value="todo">âœ… ToDoæŠ½å‡º</option>
                <option value="full">ğŸ“„ è­°äº‹éŒ²æ•´å½¢</option>
            </select>
            <div style="display:flex; gap:6px;">
                <button class="btn-sm btn-upload" onclick="document.getElementById('fileInput').click()">
                    ğŸ“‚<span style="display:none; @media(min-width:400px){display:inline;}"> ãƒ•ã‚¡ã‚¤ãƒ«</span>
                </button>
                <input type="file" id="fileInput" accept="audio/*" onchange="handleFileUpload(this)">
                <button id="btnAiRun" class="btn-sm btn-run" onclick="runGeminiText()">
                    <span id="btnText">AIå®Ÿè¡Œ</span>
                </button>
            </div>
        </div>
        <div class="record-wrapper" id="recordWrapper">
            <div class="record-ring"></div>
            <button class="btn-record" id="btnRecord" onclick="toggleRecording()">
                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                <div id="stopIcon"></div>
            </button>
        </div>
    </div>
</div>

<div id="loadingOverlay">
    <div class="pulse-logo">âœ¨</div>
    <div class="loading-text" id="loadingText">AIãŒæ€è€ƒä¸­ã§ã™...</div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0; font-size:22px;">âš™ï¸ è¨­å®š</h2>
        <p style="font-size:14px; color:#666; line-height:1.6; margin-bottom:15px;">
            Google AI Studioã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            <span style="font-size:12px; opacity:0.7;">ä¿å­˜æ™‚ã«ã€ã‚ãªãŸã®ã‚­ãƒ¼ã§åˆ©ç”¨å¯èƒ½ãªæœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•ã§è¨­å®šã—ã¾ã™ã€‚</span>
        </p>
        
        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-link-btn">
            ğŸ”‘ APIã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ (Google AI Studio)
        </a>

        <input type="text" id="apiKeyInput" placeholder="AIzaSy..." style="width:100%; padding:16px; margin-bottom:15px; border:1px solid #E5E5EA; border-radius:14px; font-family:monospace; background:#F9F9F9; outline:none; transition:0.2s;">
        <div id="modelStatus" style="font-size:13px; background:#F2F2F7; padding:16px; display:none; border-radius:14px; margin-bottom:20px; color:#333; line-height:1.5;"></div>
        <button onclick="saveSettings()" style="width:100%; padding:16px; background:var(--accent); color:white; border:none; border-radius:14px; font-weight:bold; font-size:15px; cursor:pointer; box-shadow: 0 4px 15px rgba(0,113,227,0.3);">ä¿å­˜ & è‡ªå‹•è¨­å®š</button>
        <button onclick="closeSettings()" style="width:100%; padding:16px; background:transparent; color:#888; border:none; margin-top:8px; cursor:pointer; font-weight:600;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0; font-size:22px;">âœ¨ ç”Ÿæˆçµæœ</h2>
            <button onclick="closeResult()" style="background:none; border:none; font-size:28px; color:#C7C7CC; cursor:pointer; padding:0;">&times;</button>
        </div>
        <div id="aiOutput" class="ai-result"></div>
        <div style="text-align:right; margin-top:24px; display:flex; gap:12px; justify-content:flex-end;">
            <button onclick="downloadResultText()" style="padding:12px 20px; background:#F2F2F7; color:#333; border:none; border-radius:12px; font-weight:bold; cursor:pointer; transition:0.2s;">ä¿å­˜(.txt)</button>
            <button onclick="copyResult()" style="padding:12px 20px; background:var(--text-main); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15); transition:0.2s;">ã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>
</div>

<script>
    /* --- åˆæœŸåŒ–ã¨å®šæ•° --- */
    const STORAGE_KEY_HTML = 'ai_minutes_max_html';
    const STORAGE_KEY_API = 'ai_minutes_api_key';
    const STORAGE_KEY_MODEL = 'ai_minutes_model';

    const logArea = document.getElementById('logArea');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const aiOutput = document.getElementById('aiOutput');
    const btnRecord = document.getElementById('btnRecord');
    const recordWrapper = document.getElementById('recordWrapper');
    const audioPlayerContainer = document.getElementById('audioPlayerContainer');
    const audioPlayer = document.getElementById('audioPlayer');
    const downloadLink = document.getElementById('downloadLink');
    const emptyState = document.getElementById('empty-state');
    const mainScroll = document.getElementById('mainScroll');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let recognition;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    function init() {
        if (localStorage.getItem(STORAGE_KEY_HTML)) {
            logArea.innerHTML = localStorage.getItem(STORAGE_KEY_HTML);
            if(logArea.children.length > 0) emptyState.style.display = 'none';
        }
        if (localStorage.getItem(STORAGE_KEY_API)) apiKeyInput.value = localStorage.getItem(STORAGE_KEY_API);
        
        setupRecognition();
        if (!localStorage.getItem(STORAGE_KEY_API)) setTimeout(openSettings, 800);
    }

    /* --- ãƒ­ã‚°æ¶ˆå» --- */
    function clearLogs() {
        if(logArea.innerHTML.trim() === "" && audioPlayerContainer.style.display === "none") return;
        
        if(confirm("ä¼šè©±ãƒ­ã‚°ã¨éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            logArea.innerHTML = "";
            localStorage.removeItem(STORAGE_KEY_HTML);
            emptyState.style.display = "flex";
            audioPlayerContainer.style.display = "none";
            audioPlayer.src = "";
            if(isRecording) toggleRecording();
        }
    }

    /* --- Speech to Text --- */
    function setupRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return;

        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'ja-JP';

        recognition.onresult = (event) => {
            let finalStr = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) finalStr += event.results[i][0].transcript;
            }
            if (finalStr) {
                addMessage(finalStr);
            }
        };

        recognition.onend = () => { 
            if (isRecording) {
                try { recognition.start(); } catch(e) { stopUI(); }
            } else {
                stopUI();
            }
        };
    }

    function addMessage(text) {
        emptyState.style.display = 'none';
        
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const div = document.createElement('div');
        div.className = 'msg-bubble';
        div.innerHTML = `<span class="msg-time">${time}</span><div class="msg-text">${text}</div>`;
        
        const isNearBottom = mainScroll.scrollHeight - mainScroll.scrollTop - mainScroll.clientHeight < 200;
        
        logArea.appendChild(div);
        localStorage.setItem(STORAGE_KEY_HTML, logArea.innerHTML);

        if (isNearBottom) {
            mainScroll.scrollTo({ top: mainScroll.scrollHeight, behavior: 'smooth' });
        }
    }

    /* --- Audio Recording --- */
    async function startAudioRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                
                audioPlayer.src = url;
                audioPlayerContainer.style.display = "flex";
                mainScroll.scrollTo({ top: mainScroll.scrollHeight, behavior: 'smooth' });

                const timestamp = new Date().toISOString().slice(0,16).replace('T','_').replace(':','');
                downloadLink.href = url;
                downloadLink.download = `Max_Rec_${timestamp}.webm`;
                
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
        } catch (e) {
            console.error("ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼:", e);
            alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚æ–‡å­—èµ·ã“ã—æ©Ÿèƒ½ã®ã¿å‹•ä½œã—ã¾ã™ã€‚");
        }
    }

    function toggleRecording() {
        if (isRecording) {
            isRecording = false;
            recognition.stop();
            if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
            stopUI();
        } else {
            if(logArea.children.length > 0) {
                 const hr = document.createElement('div');
                 hr.className = 'system-msg';
                 hr.innerText = 'éŒ²éŸ³é–‹å§‹';
                 logArea.appendChild(hr);
            }

            isRecording = true;
            recognition.start();
            startAudioRecording();
            startUI();
            audioPlayerContainer.style.display = "none"; 
        }
    }

    function startUI() {
        recordWrapper.classList.add('recording');
    }
    function stopUI() {
        recordWrapper.classList.remove('recording');
        isRecording = false;
    }

    /* --- UI & AI Functions --- */
    function openSettings() { document.getElementById('settingsModal').classList.add('open'); }
    function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
    function closeResult() { document.getElementById('resultModal').classList.remove('open'); }
    
    function copyResult() { navigator.clipboard.writeText(aiOutput.innerText); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"); }
    function downloadResultText() {
        const blob = new Blob([aiOutput.innerText], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Max_Minutes_${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
    }

    function shareText() {
        const plainText = logArea.innerText.replace(/\n\n/g, '\n');
        if(!plainText.trim()) return alert("å…±æœ‰ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“");
        
        if(navigator.share) {
            navigator.share({ title: 'æ–‡å­—ãŠã“ã—Max ãƒ­ã‚°', text: plainText });
        } else {
            navigator.clipboard.writeText(plainText);
            alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }
    }

    async function saveSettings() {
        const key = apiKeyInput.value.trim();
        const log = document.getElementById('modelStatus');
        log.style.display = "block"; log.innerHTML = "ğŸ“¡ æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...";
        
        if(!key) {
            log.innerHTML = `<span style="color:#FF3B30;">âŒ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>`;
            return;
        }

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            
            if(data.error) throw new Error(data.error.message);
            if(!data.models) throw new Error("ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆå–å¾—å¤±æ•—");

            const availableModels = data.models.filter(m => 
                m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")
            );

            if(availableModels.length === 0) throw new Error("åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");

            let selectedModel = availableModels.find(m => m.name.includes("gemini-1.5-flash"));
            if (!selectedModel) selectedModel = availableModels.find(m => m.name.includes("gemini-1.5-pro"));
            if (!selectedModel) selectedModel = availableModels[0];

            const modelName = selectedModel.name.replace(/^models\//, '');
            
            localStorage.setItem(STORAGE_KEY_API, key);
            localStorage.setItem(STORAGE_KEY_MODEL, modelName);
            
            log.innerHTML = `<span style="color:#34C759; font-weight:bold;">âœ… æ¥ç¶šæˆåŠŸ</span><br>è¨­å®šãƒ¢ãƒ‡ãƒ«: ${modelName}`;
            setTimeout(closeSettings, 1200);

        } catch(e) {
            log.innerHTML = `<span style="color:#FF3B30; font-weight:bold;">âŒ ã‚¨ãƒ©ãƒ¼</span><br>${e.message}`;
        }
    }

    async function runGeminiText() {
        const text = logArea.innerText;
        if(!text.trim()) return alert("ä¼šè©±ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“");
        setLoading(true, "AIãŒä¼šè©±ã‚’åˆ†æä¸­...");
        
        const mode = document.getElementById('modeSelect').value;
        let prompt = "ä»¥ä¸‹ã®ä¼šè©±ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚";
        if(mode === 'todo') prompt = "ä»¥ä¸‹ã®ä¼šè©±ã‹ã‚‰ã€ã‚„ã‚‹ã¹ãã‚¿ã‚¹ã‚¯ï¼ˆToDoï¼‰ã¨æ±ºå®šäº‹é …ã ã‘ã‚’æŠ½å‡ºã—ã€ç®‡æ¡æ›¸ãã«ã—ã¦ãã ã•ã„ã€‚";
        if(mode === 'full') prompt = "ä»¥ä¸‹ã®ä¼šè©±ãƒ­ã‚°ã‚’ã€èª¤å­—è„±å­—ã‚’ä¿®æ­£ã—ã¦èª­ã¿ã‚„ã™ã„è­°äº‹éŒ²å½¢å¼ï¼ˆè¦‹å‡ºã—ä»˜ãï¼‰ã«æ•´å½¢ã—ã¦ãã ã•ã„ã€‚";

        try {
            await callGemini([{ text: prompt + "\n\n" + text }]);
        } catch(e) { 
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message); 
            console.error(e);
        }
        finally { setLoading(false); }
    }

    async function handleFileUpload(input) {
        const file = input.files[0];
        if(!file) return;
        
        if(!confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€\nã‚’AIã«é€ä¿¡ã—ã¦è§£æã—ã¾ã™ã‹ï¼Ÿ`)) {
            input.value = ""; return;
        }

        setLoading(true, "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡ãƒ»è§£æä¸­...");
        try {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                await callGemini([
                    { text: "ã“ã®éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã—ã—ã€ãã®å¾Œã«å†…å®¹ã®è¦ç´„ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\nå‡ºåŠ›å½¢å¼:\n## æ–‡å­—èµ·ã“ã—\n(ã“ã“ã«å…¨æ–‡)\n\n## è¦ç´„\n(ã“ã“ã«è¦ç´„)" },
                    { inline_data: { mime_type: file.type, data: base64 } }
                ]);
                input.value = "";
            };
        } catch(e) { 
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message); 
            console.error(e);
            setLoading(false);
            input.value = "";
        }
    }

    async function callGemini(parts) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        let model = localStorage.getItem(STORAGE_KEY_MODEL);
        
        if(!key) { alert("è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãã ã•ã„"); return; }
        if(!model) { alert("è¨­å®šç”»é¢ã‚’é–‹ãã€[ä¿å­˜] ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚"); openSettings(); return; }

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ contents: [{ parts }] })
        });
        const data = await res.json();
        
        if(data.error) throw new Error(data.error.message);
        
        if (!data.candidates || data.candidates.length === 0) throw new Error("AIå¿œç­”ãªã—");
        const candidate = data.candidates[0];
        if (candidate.finishReason && candidate.finishReason !== "STOP" && !candidate.content) {
            throw new Error(`ç”Ÿæˆä¸­æ–­: ${candidate.finishReason}`);
        }
        
        aiOutput.innerText = candidate.content.parts[0].text;
        document.getElementById('resultModal').classList.add('open');
    }

    function setLoading(flag, txt="AIæ€è€ƒä¸­...") {
        loadingOverlay.style.display = flag ? "flex" : "none";
        document.getElementById('loadingText').innerText = txt;
    }

    init();
</script>
</body>
</html>